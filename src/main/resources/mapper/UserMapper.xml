<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.famigo.backend.mapper.UserMapper">

  <!-- =========================================================
       users テーブル → User(Entity) にマッピングする resultMap
       （DBの snake_case と Javaの camelCase を紐付ける）
       ========================================================= -->
  <resultMap id="UserResultMap" type="com.famigo.backend.entity.User">
    <id     property="id"           column="id" />
    <result property="name"         column="name" />
    <result property="email"        column="email" />
    <result property="passwordHash" column="password_hash" />
    <result property="role"         column="role" />
    <result property="createdAt"    column="created_at" />
    <result property="updatedAt"    column="updated_at" />
    <result property="isDeleted"    column="is_deleted" />
  </resultMap>

  <!-- =========================================================
       email から users を1件取得（論理削除ユーザーは除外）
       用途：ログイン時（JWT認証）にユーザーを特定する
       ========================================================= -->
  <select id="findActiveByEmail" resultMap="UserResultMap">
    SELECT
      id,
      name,
      email,
      password_hash,
      role,
      created_at,
      updated_at,
      is_deleted
    FROM
      users
    WHERE
      email = #{email}
      AND is_deleted = 0
    LIMIT 1
  </select>

  <!-- =========================================================
       id から users を1件取得（論理削除ユーザーは除外）
       用途：JWTの userId からユーザーを復元する（認可/ユーザー情報取得など）
       ========================================================= -->
  <select id="findActiveById" resultMap="UserResultMap">
    SELECT
      id,
      name,
      email,
      password_hash,
      role,
      created_at,
      updated_at,
      is_deleted
    FROM
      users
    WHERE
      id = #{id}
      AND is_deleted = 0
    LIMIT 1
  </select>

  <!-- =========================================================
       ユーザー新規作成（サインアップ）
       ========================================================= -->
  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO users (
      name,
      email,
      password_hash,
      role,
      created_at,
      updated_at,
      is_deleted
    )
    VALUES (
      #{name},
      #{email},
      #{passwordHash},
      #{role},
      NOW(),
      NOW(),
      0
    )
  </insert>

  <!-- =========================================================
       ユーザー情報更新
       ①表示名更新（users.name）
       ========================================================= -->
  <update id="updateName">
    UPDATE
      users
    SET
      name = #{name},
      updated_at = NOW()
    WHERE
      id = #{id}
      AND is_deleted = 0
  </update>

  <!-- =========================================================
       ユーザー情報更新
       ②メールアドレス更新（users.email）
       ========================================================= -->
  <update id="updateEmail">
    UPDATE
      users
    SET
      email = #{email},
      updated_at = NOW()
    WHERE
      id = #{id}
      AND is_deleted = 0
  </update>

  <!-- =========================================================
       ユーザー情報更新
       ①-②まとめて更新（users.name + users.email）
       用途：アカウント設定画面の「更新」ボタン
       方針（原子性）：入力エラーがあれば、どの項目も更新しない
       ========================================================= -->
  <update id="updateProfile">
    UPDATE
      users
    SET
      name = #{name},
      email = #{email},
      updated_at = NOW()
    WHERE
      id = #{id}
      AND is_deleted = 0
  </update>

  <!-- =========================================================
       ユーザー情報更新
       ③パスワード更新（users.password_hash）
       ========================================================= -->
  <update id="updatePasswordHash">
    UPDATE
      users
    SET
      password_hash = #{passwordHash},
      updated_at = NOW()
    WHERE
      id = #{id}
      AND is_deleted = 0
  </update>

  <!-- =========================================================
       退会（論理削除）
       - is_deleted を 1 にする
       - 表示名を「退会ユーザー」に更新する
       ========================================================= -->
  <update id="withdraw">
    UPDATE
      users
    SET
      is_deleted = 1,
      name = #{withdrawnName},
      updated_at = NOW()
    WHERE
      id = #{id}
      AND is_deleted = 0
  </update>

</mapper>
