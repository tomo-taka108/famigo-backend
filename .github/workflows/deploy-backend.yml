name: Deploy Backend (S3 + SSM)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  S3_BUCKET: famigo-odekake-backend-artifacts
  S3_KEY: backend/app.jar

jobs:
  test:
    runs-on: ubuntu-22.04

    # Testcontainers が Docker を掴みやすくする
    env:
      DOCKER_HOST: unix:///var/run/docker.sock

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # Docker起動 + 権限調整 + 疎通確認（ここが重要）
      - name: Ensure Docker is running (for Testcontainers)
        run: |
          set -eux

          sudo systemctl start docker
          sudo systemctl status docker --no-pager || true

          echo "=== whoami / groups ==="
          whoami
          id
          groups

          echo "=== docker.sock ==="
          ls -l /var/run/docker.sock || true

          # runnerユーザーをdockerグループへ（権限問題の王道）
          sudo usermod -aG docker $USER || true

          # docker.sock の権限が厳しくて Testcontainers が死ぬことがあるので保険
          sudo chmod 666 /var/run/docker.sock || true

          echo "=== docker version/info ==="
          docker --version
          docker info

      - name: Run tests
        run: |
          chmod +x ./gradlew
          ./gradlew clean test --no-daemon

  deploy:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Build bootJar (app.jar
