<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.famigo.backend.mapper.UserMapper">

  <!-- =========================================================
       users テーブル → User(Entity) にマッピングする resultMap
       （DBの snake_case と Javaの camelCase を紐付ける）
       ========================================================= -->
  <resultMap id="UserResultMap" type="com.famigo.backend.entity.User">
    <id     property="id"           column="id" />
    <result property="name"         column="name" />
    <result property="email"        column="email" />
    <result property="passwordHash" column="password_hash" />
    <result property="role"         column="role" />
    <result property="createdAt"    column="created_at" />
    <result property="updatedAt"    column="updated_at" />
    <result property="isDeleted"    column="is_deleted" />
  </resultMap>

  <!-- =========================================================
       email から users を1件取得（論理削除ユーザーは除外）
       用途：ログイン時（JWT認証）にユーザーを特定する
       ========================================================= -->
  <select id="findActiveByEmail" resultMap="UserResultMap">
    SELECT
      id,
      name,
      email,
      password_hash,
      role,
      created_at,
      updated_at,
      is_deleted
    FROM
      users
    WHERE
      email = #{email}
      AND is_deleted = 0
    LIMIT 1
  </select>

  <!-- =========================================================
       id から users を1件取得（論理削除ユーザーは除外）
       用途：JWTの userId からユーザーを復元する（認可/ユーザー情報取得など）
       ========================================================= -->
  <select id="findActiveById" resultMap="UserResultMap">
    SELECT
      id,
      name,
      email,
      password_hash,
      role,
      created_at,
      updated_at,
      is_deleted
    FROM
      users
    WHERE
      id = #{id}
      AND is_deleted = 0
    LIMIT 1
  </select>

</mapper>
