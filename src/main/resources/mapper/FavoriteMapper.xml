<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.famigo.backend.mapper.FavoriteMapper">

  <!-- =========================================================
       お気に入り登録（複合PK(user_id, spot_id)なので、重複時は復活させる）
       ========================================================= -->
  <insert id="upsertFavorite">
    INSERT INTO favorites (
      user_id,
      spot_id,
      created_at,
      updated_at,
      is_deleted
    )
    VALUES (
      #{userId},
      #{spotId},
      NOW(),
      NOW(),
      0
    )
    <!-- INSERT時にキー重複が発生した場合は、エラーにせずUPDATEを実行する -->
    ON DUPLICATE KEY UPDATE
      is_deleted = 0,
      updated_at = NOW()
  </insert>


  <!-- =========================================================
       お気に入り解除（論理削除）
       ========================================================= -->
  <update id="logicalDeleteFavorite">
    UPDATE favorites
    SET
      is_deleted = 1,
      updated_at = NOW()
    WHERE
      user_id = #{userId}
      AND spot_id = #{spotId}
      AND is_deleted = 0
  </update>


  <!-- =========================================================
       お気に入り済みかどうかを判定
       ========================================================= -->
  <select id="existsActiveFavorite" resultType="boolean">
    SELECT
      CASE
        WHEN COUNT(*) > 0 THEN TRUE
        ELSE FALSE
      END
    FROM favorites
    WHERE
      user_id = #{userId}
      AND spot_id = #{spotId}
      AND is_deleted = 0
  </select>


  <!-- =========================================================
       お気に入り一覧（お気に入りしたスポット一覧）を取得
       - favorites.is_deleted = 0
       - spots.is_deleted = 0
       - ORDER BY favorites.updated_at DESC（なければ created_at DESC）
       - 返却DTOは SpotListItemDto（既存ResultMapを再利用）
       ========================================================= -->
  <select id="findFavoriteSpots"
    resultMap="com.famigo.backend.mapper.SpotMapper.SpotListItemResultMap">

    SELECT
      s.id             AS spot_id,
      s.name           AS spot_name,
      s.address        AS address,
      s.area           AS area,
      s.price_type     AS price_type,
      c.name           AS category_name,
      s.target_age     AS target_age,
      s.google_map_url AS google_map_url,

      1 AS is_favorite,

      f.diaper_changing,
      f.stroller_ok,
      f.playground,
      f.athletics,
      f.water_play,
      f.indoor

    FROM
      favorites fav
      JOIN spots s
        ON fav.spot_id = s.id
        AND s.is_deleted = 0
      JOIN categories c
        ON s.category_id = c.id
      LEFT JOIN spot_facilities f
        ON s.id = f.spot_id
        AND f.is_deleted = 0

    WHERE
      fav.user_id = #{userId}
      AND fav.is_deleted = 0

    ORDER BY
      COALESCE(fav.updated_at, fav.created_at) DESC

  </select>

</mapper>
